<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BuildingHawk CRM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .tab-active { background-color: #1e40af; color: white; }
        .row-hover:hover { background-color: #f0f9ff; cursor: pointer; }
        .type-broker { background-color: #dbeafe; color: #1e40af; }
        .type-owner { background-color: #dcfce7; color: #166534; }
        .type-tenant { background-color: #fef3c7; color: #92400e; }
        .type-vendor { background-color: #f3e8ff; color: #7c3aed; }
        .type-unknown { background-color: #f3f4f6; color: #6b7280; }
        .loading { opacity: 0.5; pointer-events: none; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-900 to-blue-800 text-white p-4 shadow-lg sticky top-0 z-40">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold flex items-center gap-2">
                    <span>üèóÔ∏è</span> BuildingHawk CRM
                </h1>
                <p class="text-blue-200 text-sm">22,426 Contacts ‚Ä¢ 9,257 Properties ‚Ä¢ 24 Years of Data</p>
            </div>
            <div class="text-right">
                <div id="header-stats" class="text-sm text-blue-200"></div>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-white border-b shadow-sm sticky top-16 z-30">
        <div class="max-w-7xl mx-auto flex">
            <button onclick="showTab('contacts')" id="tab-contacts" class="px-6 py-3 font-medium tab-active transition-colors">
                üë• Contacts
            </button>
            <button onclick="showTab('properties')" id="tab-properties" class="px-6 py-3 font-medium hover:bg-gray-100 transition-colors">
                üè¢ Properties
            </button>
            <button onclick="showTab('reports')" id="tab-reports" class="px-6 py-3 font-medium hover:bg-gray-100 transition-colors">
                üìä Reports
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto p-6">
        <!-- ============================================================ -->
        <!-- CONTACTS TAB -->
        <!-- ============================================================ -->
        <div id="content-contacts" class="fade-in">
            <!-- Search & Filters -->
            <div class="bg-white rounded-lg shadow p-4 mb-6">
                <div class="flex gap-4 flex-wrap items-center">
                    <div class="flex-1 min-w-[250px]">
                        <input type="text" id="contact-search" placeholder="Search by name, email, or company..." 
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               onkeyup="debounce(loadContacts, 300)()">
                    </div>
                    <select id="contact-type-filter" class="px-4 py-2 border rounded-lg" onchange="loadContacts()">
                        <option value="">All Types</option>
                        <option value="broker">Brokers</option>
                        <option value="owner">Owners</option>
                        <option value="tenant">Tenants</option>
                        <option value="vendor">Vendors</option>
                        <option value="unknown">Unknown</option>
                    </select>
                    <select id="contact-sort" class="px-4 py-2 border rounded-lg" onchange="loadContacts()">
                        <option value="total_emails.desc">Most Emails</option>
                        <option value="total_emails.asc">Least Emails</option>
                        <option value="full_name.asc">Name A-Z</option>
                        <option value="full_name.desc">Name Z-A</option>
                        <option value="company_name.asc">Company A-Z</option>
                    </select>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6" id="contact-stats-cards">
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="text-gray-500 text-sm">Total Contacts</div>
                    <div class="text-2xl font-bold text-blue-600" id="stat-total-contacts">-</div>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="text-gray-500 text-sm">Brokers</div>
                    <div class="text-2xl font-bold text-blue-600" id="stat-brokers">-</div>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="text-gray-500 text-sm">Owners</div>
                    <div class="text-2xl font-bold text-green-600" id="stat-owners">-</div>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="text-gray-500 text-sm">Total Emails</div>
                    <div class="text-2xl font-bold text-purple-600" id="stat-total-emails">-</div>
                </div>
            </div>

            <!-- Contacts Table -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Name</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Email</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Company</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Type</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Phone</th>
                                <th class="px-4 py-3 text-right text-sm font-semibold text-gray-600">Emails</th>
                            </tr>
                        </thead>
                        <tbody id="contacts-table-body">
                            <tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
                <!-- Pagination -->
                <div class="px-4 py-3 border-t flex items-center justify-between bg-gray-50">
                    <div class="text-sm text-gray-600" id="contacts-showing">Showing 0 of 0</div>
                    <div class="flex gap-2" id="contacts-pagination"></div>
                </div>
            </div>
        </div>

        <!-- ============================================================ -->
        <!-- PROPERTIES TAB -->
        <!-- ============================================================ -->
        <div id="content-properties" class="hidden fade-in">
            <!-- Search & Filters -->
            <div class="bg-white rounded-lg shadow p-4 mb-6">
                <div class="flex gap-4 flex-wrap items-center">
                    <div class="flex-1 min-w-[250px]">
                        <input type="text" id="property-search" placeholder="Search by address or owner..." 
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                               onkeyup="debounce(loadProperties, 300)()">
                    </div>
                    <select id="property-city-filter" class="px-4 py-2 border rounded-lg" onchange="loadProperties()">
                        <option value="">All Cities</option>
                    </select>
                </div>
            </div>

            <!-- Property Stats -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="text-gray-500 text-sm">Total Properties</div>
                    <div class="text-2xl font-bold text-blue-600" id="stat-total-properties">-</div>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="text-gray-500 text-sm">For Sale</div>
                    <div class="text-2xl font-bold text-green-600" id="stat-for-sale">-</div>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="text-gray-500 text-sm">For Lease</div>
                    <div class="text-2xl font-bold text-blue-600" id="stat-for-lease">-</div>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="text-gray-500 text-sm">Total SF</div>
                    <div class="text-2xl font-bold text-purple-600" id="stat-total-sf">-</div>
                </div>
            </div>

            <!-- Properties Table -->
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Address</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">City</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Owner</th>
                                <th class="px-4 py-3 text-right text-sm font-semibold text-gray-600">Building SF</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold text-gray-600">Status</th>
                            </tr>
                        </thead>
                        <tbody id="properties-table-body">
                            <tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
                <!-- Pagination -->
                <div class="px-4 py-3 border-t flex items-center justify-between bg-gray-50">
                    <div class="text-sm text-gray-600" id="properties-showing">Showing 0 of 0</div>
                    <div class="flex gap-2" id="properties-pagination"></div>
                </div>
            </div>
        </div>

        <!-- ============================================================ -->
        <!-- REPORTS TAB -->
        <!-- ============================================================ -->
        <div id="content-reports" class="hidden fade-in">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Top Contacts -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">üèÜ Top 25 Contacts by Email Volume</h3>
                    <div id="top-contacts-list" class="space-y-2 max-h-96 overflow-y-auto">Loading...</div>
                </div>

                <!-- Contact Types Chart -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">üìä Contacts by Type</h3>
                    <canvas id="contacts-by-type-chart"></canvas>
                </div>

                <!-- Top Brokers -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">ü§ù Top Broker Relationships</h3>
                    <div id="top-brokers-list" class="space-y-2 max-h-96 overflow-y-auto">Loading...</div>
                </div>

                <!-- Top Companies -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4">üè¢ Top Companies by Email Volume</h3>
                    <div id="top-companies-list" class="space-y-2 max-h-96 overflow-y-auto">Loading...</div>
                </div>

                <!-- Properties by City Chart -->
                <div class="bg-white rounded-lg shadow p-6 lg:col-span-2">
                    <h3 class="text-lg font-semibold mb-4">üó∫Ô∏è Properties by City (Top 15)</h3>
                    <canvas id="properties-by-city-chart"></canvas>
                </div>
            </div>
        </div>
    </main>

    <!-- Contact Detail Modal -->
    <div id="contact-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6" id="contact-modal-content"></div>
        </div>
    </div>

    <script>
        const API_BASE = '';  // Same origin
        let contactsPage = 1;
        let propertiesPage = 1;
        let contactTypeChart = null;
        let propertyCityChart = null;

        // ============================================================
        // UTILITY FUNCTIONS
        // ============================================================
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function formatNumber(num) {
            return num ? num.toLocaleString() : '-';
        }

        function getTypeClass(type) {
            const classes = {
                broker: 'type-broker',
                owner: 'type-owner',
                tenant: 'type-tenant',
                vendor: 'type-vendor'
            };
            return classes[type] || 'type-unknown';
        }

        // ============================================================
        // TAB NAVIGATION
        // ============================================================

        function showTab(tab) {
            ['contacts', 'properties', 'reports'].forEach(t => {
                document.getElementById(`content-${t}`).classList.add('hidden');
                document.getElementById(`tab-${t}`).classList.remove('tab-active');
            });
            document.getElementById(`content-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).classList.add('tab-active');

            if (tab === 'properties') loadProperties();
            if (tab === 'reports') loadReports();
        }

        // ============================================================
        // CONTACTS
        // ============================================================

        async function loadContacts(page = 1) {
            contactsPage = page;
            const search = document.getElementById('contact-search').value;
            const type = document.getElementById('contact-type-filter').value;
            const sort = document.getElementById('contact-sort').value;

            const params = new URLSearchParams({
                page, limit: 50, sort,
                ...(search && { search }),
                ...(type && { type })
            });

            try {
                const res = await fetch(`${API_BASE}/api/contacts?${params}`);
                const data = await res.json();
                renderContacts(data);
            } catch (err) {
                console.error('Error loading contacts:', err);
            }
        }

        function renderContacts(data) {
            const tbody = document.getElementById('contacts-table-body');
            
            if (!data.contacts || data.contacts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">No contacts found</td></tr>';
                return;
            }

            tbody.innerHTML = data.contacts.map(c => `
                <tr class="border-b row-hover" onclick="showContactModal('${c.id}')">
                    <td class="px-4 py-3">
                        <div class="font-medium">${c.full_name || 'Unknown'}</div>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-600">${c.primary_email || '-'}</td>
                    <td class="px-4 py-3 text-sm">${c.company_name || '-'}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${getTypeClass(c.contact_type)}">
                            ${c.contact_type || 'unknown'}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-600">${c.phones?.[0] || '-'}</td>
                    <td class="px-4 py-3 text-right font-semibold text-blue-600">${formatNumber(c.total_emails)}</td>
                </tr>
            `).join('');

            // Update showing text
            const start = (data.page - 1) * 50 + 1;
            const end = Math.min(data.page * 50, data.total);
            document.getElementById('contacts-showing').textContent = `Showing ${start}-${end} of ${formatNumber(data.total)}`;

            // Pagination
            renderPagination('contacts-pagination', data.page, data.pages, loadContacts);
        }

        async function loadContactStats() {
            try {
                const res = await fetch(`${API_BASE}/api/contacts/stats`);
                const stats = await res.json();
                
                document.getElementById('stat-total-contacts').textContent = formatNumber(stats.total);
                document.getElementById('stat-brokers').textContent = formatNumber(stats.by_type?.broker || 0);
                document.getElementById('stat-owners').textContent = formatNumber(stats.by_type?.owner || 0);
                document.getElementById('stat-total-emails').textContent = formatNumber(stats.total_emails);
            } catch (err) {
                console.error('Error loading contact stats:', err);
            }
        }

        async function showContactModal(id) {
            try {
                const res = await fetch(`${API_BASE}/api/contacts/${id}`);
                const data = await res.json();
                const c = data.contact;

                document.getElementById('contact-modal-content').innerHTML = `
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h2 class="text-2xl font-bold">${c.full_name || 'Unknown'}</h2>
                            <p class="text-gray-600">${c.company_name || ''}</p>
                        </div>
                        <button onclick="closeContactModal()" class="text-gray-400 hover:text-gray-600 text-3xl leading-none">&times;</button>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div>
                            <div class="text-sm text-gray-500">Email</div>
                            <div class="font-medium">${c.primary_email || '-'}</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-500">Phone</div>
                            <div class="font-medium">${c.phones?.[0] || '-'}</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-500">Type</div>
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${getTypeClass(c.contact_type)}">
                                ${c.contact_type || 'unknown'}
                            </span>
                        </div>
                        <div>
                            <div class="text-sm text-gray-500">Source</div>
                            <div class="font-medium">${c.source || '-'}</div>
                        </div>
                    </div>

                    <div class="bg-blue-50 rounded-lg p-4 mb-6">
                        <div class="text-sm text-blue-600">Email History</div>
                        <div class="text-3xl font-bold text-blue-700">${formatNumber(c.total_emails)} emails</div>
                        <div class="text-sm text-blue-500">in your 24-year archive</div>
                    </div>

                    ${c.notes ? `
                        <div class="mb-6">
                            <div class="text-sm text-gray-500 mb-1">Notes</div>
                            <div class="bg-gray-50 rounded p-3">${c.notes}</div>
                        </div>
                    ` : ''}

                    ${data.properties?.length ? `
                        <div>
                            <div class="text-sm text-gray-500 mb-2">Linked Properties (${data.properties.length})</div>
                            <div class="space-y-2">
                                ${data.properties.map(p => `
                                    <div class="bg-gray-50 rounded p-3">
                                        <div class="font-medium">${p.properties?.address || 'Unknown'}</div>
                                        <div class="text-sm text-gray-600">${p.properties?.city || ''} ‚Ä¢ ${p.role || ''}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                `;

                document.getElementById('contact-modal').classList.remove('hidden');
            } catch (err) {
                console.error('Error loading contact:', err);
            }
        }

        function closeContactModal() {
            document.getElementById('contact-modal').classList.add('hidden');
        }

        // ============================================================
        // PROPERTIES
        // ============================================================

        async function loadProperties(page = 1) {
            propertiesPage = page;
            const search = document.getElementById('property-search').value;
            const city = document.getElementById('property-city-filter').value;

            const params = new URLSearchParams({
                page, limit: 50,
                ...(search && { search }),
                ...(city && { city })
            });

            try {
                const res = await fetch(`${API_BASE}/api/properties?${params}`);
                const data = await res.json();
                renderProperties(data);
            } catch (err) {
                console.error('Error loading properties:', err);
            }
        }

        function renderProperties(data) {
            const tbody = document.getElementById('properties-table-body');
            
            if (!data.properties || data.properties.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">No properties found</td></tr>';
                return;
            }

            tbody.innerHTML = data.properties.map(p => `
                <tr class="border-b row-hover">
                    <td class="px-4 py-3 font-medium">${p.address || '-'}</td>
                    <td class="px-4 py-3">${p.city || '-'}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${(p.owner_name || '-').substring(0, 40)}</td>
                    <td class="px-4 py-3 text-right">${p.building_sf ? formatNumber(p.building_sf) + ' SF' : '-'}</td>
                    <td class="px-4 py-3 text-center">
                        ${p.for_sale ? '<span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs mr-1">Sale</span>' : ''}
                        ${p.for_lease ? '<span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs">Lease</span>' : ''}
                        ${!p.for_sale && !p.for_lease ? '<span class="text-gray-400">-</span>' : ''}
                    </td>
                </tr>
            `).join('');

            // Update showing text
            const start = (data.page - 1) * 50 + 1;
            const end = Math.min(data.page * 50, data.total);
            document.getElementById('properties-showing').textContent = `Showing ${start}-${end} of ${formatNumber(data.total)}`;

            // Pagination
            renderPagination('properties-pagination', data.page, data.pages, loadProperties);
        }

        async function loadPropertyStats() {
            try {
                const res = await fetch(`${API_BASE}/api/properties/stats`);
                const stats = await res.json();
                
                document.getElementById('stat-total-properties').textContent = formatNumber(stats.total);
                document.getElementById('stat-for-sale').textContent = formatNumber(stats.for_sale);
                document.getElementById('stat-for-lease').textContent = formatNumber(stats.for_lease);
                document.getElementById('stat-total-sf').textContent = formatNumber(stats.total_sf);
            } catch (err) {
                console.error('Error loading property stats:', err);
            }
        }

        async function loadCities() {
            try {
                const res = await fetch(`${API_BASE}/api/properties/cities`);
                const cities = await res.json();
                
                const select = document.getElementById('property-city-filter');
                select.innerHTML = '<option value="">All Cities</option>' + 
                    cities.map(c => `<option value="${c}">${c}</option>`).join('');
            } catch (err) {
                console.error('Error loading cities:', err);
            }
        }

        // ============================================================
        // REPORTS
        // ============================================================

        async function loadReports() {
            await Promise.all([
                loadTopContacts(),
                loadTopBrokers(),
                loadTopCompanies(),
                loadContactTypeChart(),
                loadPropertyCityChart()
            ]);
        }

        async function loadTopContacts() {
            try {
                const res = await fetch(`${API_BASE}/api/reports/top-contacts?limit=25`);
                const contacts = await res.json();
                
                document.getElementById('top-contacts-list').innerHTML = contacts.map((c, i) => `
                    <div class="flex items-center justify-between py-2 border-b last:border-0">
                        <div class="flex items-center gap-3">
                            <span class="text-gray-400 w-6">${i + 1}.</span>
                            <div>
                                <div class="font-medium">${c.full_name || 'Unknown'}</div>
                                <div class="text-xs text-gray-500">${c.company_name || c.primary_email || ''}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-semibold text-blue-600">${formatNumber(c.total_emails)}</div>
                            <div class="text-xs text-gray-400">emails</div>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Error loading top contacts:', err);
            }
        }

        async function loadTopBrokers() {
            try {
                const res = await fetch(`${API_BASE}/api/reports/brokers`);
                const data = await res.json();
                
                document.getElementById('top-brokers-list').innerHTML = data.brokers.slice(0, 25).map((c, i) => `
                    <div class="flex items-center justify-between py-2 border-b last:border-0">
                        <div class="flex items-center gap-3">
                            <span class="text-gray-400 w-6">${i + 1}.</span>
                            <div>
                                <div class="font-medium">${c.full_name || 'Unknown'}</div>
                                <div class="text-xs text-gray-500">${c.company_name || ''}</div>
                            </div>
                        </div>
                        <div class="font-semibold text-blue-600">${formatNumber(c.total_emails)}</div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Error loading brokers:', err);
            }
        }

        async function loadTopCompanies() {
            try {
                const res = await fetch(`${API_BASE}/api/reports/companies`);
                const companies = await res.json();
                
                document.getElementById('top-companies-list').innerHTML = companies.slice(0, 25).map((c, i) => `
                    <div class="flex items-center justify-between py-2 border-b last:border-0">
                        <div class="flex items-center gap-3">
                            <span class="text-gray-400 w-6">${i + 1}.</span>
                            <div>
                                <div class="font-medium">${c.name}</div>
                                <div class="text-xs text-gray-500">${c.contacts} contacts</div>
                            </div>
                        </div>
                        <div class="font-semibold text-blue-600">${formatNumber(c.total_emails)}</div>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Error loading companies:', err);
            }
        }

        async function loadContactTypeChart() {
            try {
                const res = await fetch(`${API_BASE}/api/contacts/stats`);
                const stats = await res.json();
                
                const ctx = document.getElementById('contacts-by-type-chart').getContext('2d');
                
                if (contactTypeChart) contactTypeChart.destroy();
                
                contactTypeChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(stats.by_type || {}),
                        datasets: [{
                            data: Object.values(stats.by_type || {}),
                            backgroundColor: ['#3B82F6', '#22C55E', '#F59E0B', '#A855F7', '#6B7280']
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
            } catch (err) {
                console.error('Error loading chart:', err);
            }
        }

        async function loadPropertyCityChart() {
            try {
                const res = await fetch(`${API_BASE}/api/properties/stats`);
                const stats = await res.json();
                
                // Sort and get top 15
                const sorted = Object.entries(stats.by_city || {})
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 15);
                
                const ctx = document.getElementById('properties-by-city-chart').getContext('2d');
                
                if (propertyCityChart) propertyCityChart.destroy();
                
                propertyCityChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: sorted.map(x => x[0]),
                        datasets: [{
                            label: 'Properties',
                            data: sorted.map(x => x[1]),
                            backgroundColor: '#3B82F6'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            } catch (err) {
                console.error('Error loading chart:', err);
            }
        }

        // ============================================================
        // PAGINATION
        // ============================================================

        function renderPagination(containerId, currentPage, totalPages, callback) {
            const container = document.getElementById(containerId);
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = '';
            
            // Previous
            html += `<button onclick="${callback.name}(${currentPage - 1})" 
                     ${currentPage === 1 ? 'disabled' : ''} 
                     class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">
                     ‚Üê Prev</button>`;

            // Page info
            html += `<span class="px-3 py-1">Page ${currentPage} of ${totalPages}</span>`;

            // Next
            html += `<button onclick="${callback.name}(${currentPage + 1})" 
                     ${currentPage === totalPages ? 'disabled' : ''} 
                     class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">
                     Next ‚Üí</button>`;

            container.innerHTML = html;
        }

        // ============================================================
        // INITIALIZATION
        // ============================================================

        document.addEventListener('DOMContentLoaded', async () => {
            await Promise.all([
                loadContacts(),
                loadContactStats(),
                loadPropertyStats(),
                loadCities()
            ]);
        });

        // Close modal on escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeContactModal();
        });

        // Close modal on background click
        document.getElementById('contact-modal').addEventListener('click', (e) => {
            if (e.target.id === 'contact-modal') closeContactModal();
        });
    </script>
</body>
</html>
