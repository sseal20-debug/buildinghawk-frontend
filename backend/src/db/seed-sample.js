/**
 * Seed parcels from GeoJSON file
 * Run with: npm run db:seed
 */

import pg from 'pg';
import fs from 'fs';
import path from 'path';
import dotenv from 'dotenv';

dotenv.config();

const { Client } = pg;

async function seedParcels() {
  const client = new Client({
    connectionString: process.env.DATABASE_URL,
    ssl: { rejectUnauthorized: false }
  });

  try {
    await client.connect();
    console.log('Connected to database');

    // Sample parcel data from your PropertyData.csv conversion
    const parcels = [
      {
        apn: "346-221-13",
        address: "5399 E HUNTER AVE",
        city: "ANAHEIM",
        zip: "92807",
        owner: "RICHARDSON LIVING TRUST",
        land_sf: 75607,
        geometry: [[-117.7981154648556,33.8633006537146],[-117.79813104373966,33.862494812342874],[-117.79875892394735,33.86250431105788],[-117.79876352168948,33.86252792747793],[-117.79877051119574,33.86254840324184],[-117.79878002779301,33.862568157877604],[-117.79879196880938,33.86258697554572],[-117.7988062020279,33.86260464626884],[-117.79882257256747,33.86262098233684],[-117.79884089585521,33.86263579365903],[-117.79886097148564,33.862648926068196],[-117.7988825761445,33.86266023392592],[-117.79890548371274,33.86266959911093],[-117.79892943857524,33.8626769121126],[-117.79895418570369,33.862682096391964],[-117.79899481206112,33.862685830651905],[-117.79902990093125,33.86268662145625],[-117.79883801987,33.86342534827953],[-117.7981154648556,33.8633006537146]]
      },
      {
        apn: "346-221-24",
        address: "5395 E HUNTER AVE",
        city: "ANAHEIM",
        zip: "92807",
        owner: "BARKER & POLLOCK",
        land_sf: 96485,
        geometry: [[-117.79883801987,33.86342534827953],[-117.79902990093125,33.86268662145625],[-117.79913000530172,33.86268880770874],[-117.79916437251214,33.86269106673983],[-117.79918795332897,33.862694393874435],[-117.80006397254405,33.862845562788806],[-117.7998701553461,33.86360346780553],[-117.79883801987,33.86342534827953]]
      },
      {
        apn: "346-222-02",
        address: "5330 E HUNTER AVE",
        city: "ANAHEIM",
        zip: "92807",
        owner: "CIRCUIT WORLD INC",
        land_sf: 46310,
        geometry: [[-117.80153626729836,33.862676436387126],[-117.80153537015102,33.86209797978774],[-117.80219881907419,33.862094864101074],[-117.80219779231773,33.862463004726436],[-117.8024056041772,33.86246202847401],[-117.8024029114779,33.86267236886915],[-117.80153626729836,33.862676436387126]]
      },
      {
        apn: "346-231-09",
        address: "5395 E LA PALMA AVE",
        city: "ANAHEIM",
        zip: "92807",
        owner: "ELLAS PROPERTIES",
        land_sf: 179554,
        geometry: [[-117.79821172847363,33.85971396284516],[-117.79886691910005,33.85966601930927],[-117.79887771864975,33.85966663573217],[-117.79889718459098,33.85967035744543],[-117.79891529265605,33.859677371898954],[-117.79893126005275,33.85968737824337],[-117.79894438382992,33.859699934479266],[-117.79895409091559,33.85971449256423],[-117.79895995492713,33.85973041744172],[-117.79896172654699,33.85974702788836],[-117.79894521685516,33.860601327843966],[-117.79894243345278,33.86063519328274],[-117.79893541903078,33.860668621973524],[-117.7989303488392,33.86068506712451],[-117.79884033875311,33.860948255666976],[-117.79882630446068,33.86099927494092],[-117.79881873726318,33.8610512446567],[-117.79881741117008,33.861077413420865],[-117.7988094400758,33.86149020286269],[-117.79815040984982,33.8614932925956],[-117.79818474642015,33.8597171607894],[-117.79821172847363,33.85971396284516]]
      },
      {
        apn: "346-261-08",
        address: "5455 E LA PALMA AVE",
        city: "ANAHEIM",
        zip: "92807",
        owner: "CLPF-LA PALMA",
        land_sf: 126560,
        geometry: [[-117.7954576252635,33.862842077668844],[-117.79545732618827,33.86228091436885],[-117.79553665171396,33.86229416929807],[-117.7955290478179,33.86084419508458],[-117.79657408815301,33.860844620404926],[-117.79658332753324,33.86303623814299],[-117.7954576252635,33.862842077668844]]
      },
      {
        apn: "346-271-11",
        address: "5615 E LA PALMA AVE",
        city: "ANAHEIM",
        zip: "92807",
        owner: "MICROMETALS INC",
        land_sf: 124389,
        geometry: [[-117.79311701496044,33.86147515276867],[-117.79311686408089,33.86144492393042],[-117.79330791044248,33.86144423025034],[-117.79330800136019,33.861463464098875],[-117.79400440154662,33.861460935822194],[-117.79400792118929,33.86213909614661],[-117.79318773661596,33.862142081123196],[-117.79318821698791,33.86222727078514],[-117.79269943792426,33.862229040042244],[-117.79270015159553,33.86236641323513],[-117.79250832593195,33.86233330942346],[-117.79246714682205,33.862222961733345],[-117.7924693402165,33.86147747870939],[-117.79311701496044,33.86147515276867]]
      },
      {
        apn: "346-271-12",
        address: "5605 E LA PALMA AVE",
        city: "ANAHEIM",
        zip: "92807",
        owner: "CALVARY CHAPEL EAST ANAHEIM",
        land_sf: 121201,
        geometry: [[-117.7924693402165,33.86147747870939],[-117.79247065134811,33.86103314543189],[-117.79253654936045,33.86103292843602],[-117.79253739608805,33.86073982031267],[-117.79400064203722,33.86073455757947],[-117.79400440154662,33.861460935822194],[-117.79330800136019,33.861463464098875],[-117.79330791044248,33.86144423025034],[-117.79311686408089,33.86144492393042],[-117.79311701496044,33.86147515276867],[-117.7924693402165,33.86147747870939]]
      },
      {
        apn: "346-421-05",
        address: "5420 E LA PALMA AVE",
        city: "ANAHEIM",
        zip: "92807",
        owner: "MMG PROPERTY LLC",
        land_sf: 135341,
        geometry: [[-117.79696319842274,33.85964542125586],[-117.79695443727297,33.857256536671905],[-117.79823508684868,33.85710243170861],[-117.79821759985987,33.85795549936399],[-117.79813527562617,33.85795438935487],[-117.79813266070916,33.858055293538996],[-117.79717004591087,33.85803794610071],[-117.79702451099944,33.85819283909096],[-117.7970298283887,33.85963251789391],[-117.79696319842274,33.85964542125586]]
      },
      {
        apn: "346-451-02",
        address: "5464 E LA PALMA AVE",
        city: "ANAHEIM",
        zip: "92807",
        owner: "CAL-WILD LLC",
        land_sf: 105598,
        geometry: [[-117.79547151754824,33.85977504952095],[-117.79546253758633,33.8581313093489],[-117.79562889472783,33.858130681007026],[-117.7956281925365,33.85800273943717],[-117.79689107937347,33.85794399332546],[-117.79689374308417,33.858669828101114],[-117.79677007842484,33.858670138571426],[-117.79582638382546,33.858714041346026],[-117.7958245784946,33.85838428751362],[-117.79551331528624,33.85838482573445],[-117.79552093132268,33.85977544428344],[-117.79547151754824,33.85977504952095]]
      },
      {
        apn: "346-451-05",
        address: "5500 E LA PALMA AVE",
        city: "ANAHEIM",
        zip: "92807",
        owner: "CARDINAL SELF-STORAGE V",
        land_sf: 119354,
        geometry: [[-117.79425850185031,33.858842297626104],[-117.79541698837863,33.85883783737673],[-117.79542210479578,33.85977434142601],[-117.79523216740296,33.859768642063315],[-117.79420143938668,33.85972214526801],[-117.79425850185031,33.858842297626104]]
      },
      {
        apn: "352-211-01",
        address: "8015 E CRYSTAL DR",
        city: "ANAHEIM",
        zip: "92807",
        owner: "PRITI 1999 LIMITED",
        land_sf: 61654,
        geometry: [[-117.75560069076214,33.869942943540714],[-117.7556490059989,33.869737423730015],[-117.75589300164043,33.86977712561388],[-117.75616964007405,33.86978124265043],[-117.75641808930385,33.86973966608324],[-117.7567442004666,33.87020766563424],[-117.75588231368356,33.8704906217521],[-117.75560069076214,33.869942943540714]]
      },
      {
        apn: "352-211-10",
        address: "8095 E CRYSTAL DR",
        city: "ANAHEIM",
        zip: "92807",
        owner: "IDK",
        land_sf: 46347,
        geometry: [[-117.75200693913034,33.87206493464618],[-117.7523871667226,33.871260492413086],[-117.75246627235467,33.87128650706185],[-117.75280176153444,33.87114766797065],[-117.75304254193432,33.871593282403545],[-117.75277812947941,33.87170998611901],[-117.7525149705401,33.87182864542819],[-117.75225308590225,33.8719492509607],[-117.75200693913034,33.87206493464618]]
      },
      {
        apn: "352-211-11",
        address: "8080 E CRYSTAL DR",
        city: "ANAHEIM",
        zip: "92807",
        owner: "RMS EMPIRE ANAHEIM LLC",
        land_sf: 128149,
        geometry: [[-117.7523871667226,33.871260492413086],[-117.752908994243,33.87015643334538],[-117.7533820202686,33.869979244409144],[-117.75342662151806,33.87006209449009],[-117.75367959631097,33.869966977550185],[-117.75404878575057,33.87065017638693],[-117.75400930902288,33.87066518952661],[-117.75402983382882,33.870702681131256],[-117.75373828174119,33.8708150566007],[-117.7534371345118,33.87093393209692],[-117.75321393563149,33.87102389760064],[-117.75282207363114,33.871185266752775],[-117.75280176153444,33.87114766797065],[-117.75246627235467,33.87128650706185],[-117.7523871667226,33.871260492413086]]
      },
      {
        apn: "352-211-12",
        address: "8050 E CRYSTAL DR",
        city: "ANAHEIM",
        zip: "92807",
        owner: "DEERCREEK CAPITAL GROUP",
        land_sf: 90914,
        geometry: [[-117.75404878575057,33.87065017638693],[-117.75367959631097,33.869966977550185],[-117.75342662151806,33.87006209449009],[-117.7533820202686,33.869979244409144],[-117.75365119010401,33.86987842759732],[-117.75367279872066,33.869871278491914],[-117.75369335039635,33.8698657706479],[-117.75373223039706,33.869858537731396],[-117.75377352282354,33.86985513977752],[-117.75380340590097,33.869855337562974],[-117.75387697831232,33.86985951964209],[-117.7539393651756,33.869858157536335],[-117.75399446710985,33.869852775247075],[-117.75404657672316,33.86984396946618],[-117.75409106190189,33.86983345563531],[-117.7548336166963,33.869631557273664],[-117.7548671513213,33.86971737627368],[-117.75473234743765,33.869768055074715],[-117.75501749314469,33.87029576266833],[-117.75450570985586,33.8704799026097],[-117.75427674040094,33.87056442716875],[-117.75404878575057,33.87065017638693]]
      },
      {
        apn: "352-211-13",
        address: "8030 E CRYSTAL DR",
        city: "ANAHEIM",
        zip: "92807",
        owner: "H Y R ENTERPRISES",
        land_sf: 47567,
        geometry: [[-117.75515782458545,33.869604241241966],[-117.75519894996731,33.86960579293974],[-117.75523786746942,33.86961034078184],[-117.75527792088437,33.869618275519024],[-117.75531687586108,33.869629381764966],[-117.75534935795223,33.869641447707934],[-117.75538052809358,33.86965571988755],[-117.75541017139227,33.869672099909145],[-117.7554485871525,33.86969688096936],[-117.75546195123363,33.86970364566253],[-117.75547605067952,33.86970927667386],[-117.7556490059989,33.869737423730015],[-117.75560069076214,33.869942943540714],[-117.75566329720365,33.87006469691606],[-117.75501749314469,33.87029576266833],[-117.75473234743765,33.869768055074715],[-117.7548671513213,33.86971737627368],[-117.7548336166963,33.869631557273664],[-117.7549022766348,33.86961348218808],[-117.75492790711439,33.8696088646955],[-117.75495225991683,33.86960606291531],[-117.7549817099038,33.86960467273929],[-117.75515782458545,33.869604241241966]]
      },
      {
        apn: "352-221-02",
        address: "8180 E OLD CANAL RD",
        city: "ANAHEIM",
        zip: "92807",
        owner: "SAVI RANCH-SPC LLC",
        land_sf: 93540,
        geometry: [[-117.7477023098736,33.87175610317653],[-117.74760321447782,33.87157843647968],[-117.74754320300148,33.871602001465064],[-117.74717648652057,33.87096668901142],[-117.74641181463673,33.87126351072377],[-117.7463194568592,33.871100981989414],[-117.74637357801507,33.871084491764954],[-117.74640680779524,33.871076515402365],[-117.74643823564477,33.87107039309355],[-117.7477065478407,33.87073610298348],[-117.74779555222936,33.870706853425474],[-117.74779594463509,33.87074146472144],[-117.7477995998532,33.8707759430106],[-117.74780649523316,33.87081007460274],[-117.74781600834915,33.87084198577598],[-117.74782908108119,33.87087483599845],[-117.74784433361019,33.8709051579407],[-117.74786327606463,33.87093595372355],[-117.7478839090777,33.870963972862626],[-117.74789944721526,33.87098236673762],[-117.74791609320138,33.87100007338903],[-117.74793380343448,33.87101704643651],[-117.74795253152529,33.871033241421124],[-117.74798163186091,33.87105542388659],[-117.74804671506676,33.871098590652686],[-117.74809232432904,33.87113170102599],[-117.7481426335521,33.87117230993748],[-117.74818801030563,33.871213231653606],[-117.74822870013493,33.87125405377278],[-117.74826497252648,33.87129440545121],[-117.74828840673491,33.87132284563357],[-117.7483688431542,33.871425179501976],[-117.74827355970294,33.871489679184414],[-117.74830317956584,33.8715285576975],[-117.74828066395051,33.87152748694077],[-117.74825812605629,33.87152815635314],[-117.74823575876117,33.871530560205784],[-117.74821375348316,33.87153467792659],[-117.74819229854229,33.871540474276436],[-117.74817284771724,33.87154738897304],[-117.74815297599076,33.871556284101096],[-117.74813417473258,33.8715666729536],[-117.74811872849105,33.871576918927424],[-117.74810432639805,33.87158817349955],[-117.74806296903036,33.87162885826305],[-117.74803441755319,33.87165153008329],[-117.7474101826809,33.872074120454045],[-117.74733963407216,33.872001601936915],[-117.7477023098736,33.87175610317653]]
      },
      {
        apn: "354-052-03",
        address: "100 S CHAPARRAL CT",
        city: "ANAHEIM",
        zip: "92808",
        owner: "SIERRA VISTA",
        land_sf: 140655,
        geometry: [[-117.74441819170984,33.86493259989245],[-117.74379040997192,33.86469809913485],[-117.74334385062356,33.86477741248462],[-117.7430526092427,33.86376083114337],[-117.74317373311041,33.863780758198],[-117.7432943778427,33.86380261474571],[-117.74341449927965,33.86382639278632],[-117.74353405345282,33.86385208361638],[-117.74365299660123,33.86387967783217],[-117.74377128518745,33.86390916533326],[-117.74388887591353,33.86394053532638],[-117.74399887349462,33.86397176939797],[-117.74411498692092,33.864006760248046],[-117.74423027667878,33.864043597867216],[-117.74434470056738,33.864082268771455],[-117.74445821670254,33.86412275880587],[-117.74457078353232,33.86416505314983],[-117.74468235985202,33.864209136321975],[-117.74479290481928,33.864254992186254],[-117.74489596876141,33.86429975496811],[-117.74461875127615,33.86484116185146],[-117.74460357231754,33.86483634311189],[-117.74458677438868,33.86483281426352],[-117.74457067001447,33.86483106111327],[-117.74455443133435,33.86483083619607],[-117.74453826607018,33.86483214238898],[-117.74452238100477,33.864834962983444],[-117.7445059746162,33.86483959981487],[-117.74449130552726,33.86484541454336],[-117.74447663384902,33.86485309684913],[-117.74446397939165,33.86486158913024],[-117.74445255539439,33.864871219135935],[-117.74444250799131,33.864881863681],[-117.74443396570744,33.86489338660241],[-117.74442663564884,33.86490647962485],[-117.74442152692558,33.86491934026752],[-117.74441819170984,33.86493259989245]]
      },
      {
        apn: "354-052-04",
        address: "120 S CHAPARRAL CT",
        city: "ANAHEIM",
        zip: "92808",
        owner: "SIERRA VISTA",
        land_sf: 54406,
        geometry: [[-117.74334385062356,33.86477741248462],[-117.74379040997192,33.86469809913485],[-117.74441819170984,33.86493259989245],[-117.74441569619987,33.864952566913246],[-117.74441695584129,33.86497170269641],[-117.74445651729135,33.8651691071998],[-117.74350938158268,33.86535129169158],[-117.74342607512027,33.86505981852515],[-117.74334385062356,33.86477741248462]]
      },
      {
        apn: "354-052-05",
        address: "100 S CHAPARRAL CT",
        city: "ANAHEIM",
        zip: "92808",
        owner: "SIERRA VISTA",
        land_sf: 54319,
        geometry: [[-117.74350938158268,33.86535129169158],[-117.74445651729135,33.8651691071998],[-117.7445161718526,33.8654662604209],[-117.74452565838455,33.865520678790205],[-117.74453389475363,33.86558500666825],[-117.74454230532271,33.86568074198176],[-117.74454194736843,33.86569377745175],[-117.74453895598987,33.86570657532329],[-117.7445314461212,33.86572199977869],[-117.74452013478113,33.865735715595505],[-117.74450555153621,33.8657470806342],[-117.74448837913587,33.865755562812446],[-117.74447365069867,33.86575992791172],[-117.74445911593689,33.86576208936852],[-117.7443864550506,33.86576369569151],[-117.74428957543192,33.86576409635608],[-117.74419270794498,33.86576275614723],[-117.74409589753941,33.86575967568683],[-117.74399918913836,33.86575485640432],[-117.74390262761754,33.865748300536],[-117.74380625778458,33.86574001112399],[-117.74371012435805,33.865729992014806],[-117.74361427194681,33.865718247857664],[-117.74350938158268,33.86535129169158]]
      },
      {
        apn: "354-052-10",
        address: "121 S OLD SPRINGS RD",
        city: "ANAHEIM",
        zip: "92808",
        owner: "GRIFFITHS,RONALD W TRUST",
        land_sf: 56632,
        geometry: [[-117.74236503120036,33.86468560357201],[-117.74326908771154,33.86451645504706],[-117.74342607512027,33.86505981852515],[-117.74250905323414,33.8652422237045],[-117.74250844849378,33.865173889384764],[-117.74250638222158,33.86513976127154],[-117.74250281902899,33.86510286177225],[-117.74249263365948,33.865035055876355],[-117.74248579467447,33.86500136388094],[-117.74247708033539,33.864965065650615],[-117.74245836307523,33.8649014646819],[-117.74243547936088,33.86483881915658],[-117.74241470851004,33.864790581595706],[-117.74236503120036,33.86468560357201]]
      }
    ];

    console.log(`Seeding ${parcels.length} parcels...`);

    for (const p of parcels) {
      // Close the polygon ring if needed
      const coords = [...p.geometry];
      if (coords[0][0] !== coords[coords.length-1][0] || coords[0][1] !== coords[coords.length-1][1]) {
        coords.push(coords[0]);
      }
      
      const wkt = `POLYGON((${coords.map(c => `${c[0]} ${c[1]}`).join(', ')}))`;
      
      await client.query(`
        INSERT INTO parcel (apn, geometry, centroid, situs_address, city, zip, land_sf, assessor_owner_name)
        VALUES ($1, ST_GeomFromText($2, 4326), ST_Centroid(ST_GeomFromText($2, 4326)), $3, $4, $5, $6, $7)
        ON CONFLICT (apn) DO UPDATE SET
          geometry = EXCLUDED.geometry,
          centroid = EXCLUDED.centroid,
          situs_address = EXCLUDED.situs_address,
          city = EXCLUDED.city,
          zip = EXCLUDED.zip,
          land_sf = EXCLUDED.land_sf,
          assessor_owner_name = EXCLUDED.assessor_owner_name,
          updated_at = NOW()
      `, [p.apn, wkt, p.address, p.city, p.zip, p.land_sf, p.owner]);
      
      console.log(`  ✓ ${p.apn} - ${p.address}`);
    }

    // Verify
    const count = await client.query('SELECT COUNT(*) FROM parcel');
    console.log(`\n✅ Seeded ${count.rows[0].count} parcels!`);

  } catch (error) {
    console.error('❌ Error:', error.message);
    throw error;
  } finally {
    await client.end();
  }
}

seedParcels().catch(console.error);
